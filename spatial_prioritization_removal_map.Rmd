

---
title: "spatial_prioritization_removal_map"
output: html_document
---

```{r eval=FALSE, include=FALSE}
## ------------------------------------------------------------
## Fix final alive mask using final fragmentation + distance masks
##   - Run AFTER the global orchestrator has finished
##   - Does NOT modify the pipeline code; only edits rasters on disk
## ------------------------------------------------------------

library(terra)

path_outputs <- file.path("Spatial", "Outputs")

## 1. Locate final alive mask -----------------------------------------

alive_files <- list.files(
  path_outputs,
  pattern   = "^alive_mask_pruning_stage_\\d+_iter_\\d+_final\\.tif$",
  full.names = TRUE
)

if (!length(alive_files)) {
  stop("No alive_mask_pruning_stage_XXXX_iter_YYY_final.tif files found in Spatial/Outputs.")
}

alive_bn    <- basename(alive_files)
alive_stage <- as.integer(
  sub("alive_mask_pruning_stage_(\\d+)_iter_\\d+_final\\.tif", "\\1", alive_bn)
)

# Use the alive mask with the highest stage index (most recent run)
i_max             <- which.max(alive_stage)
alive_stage_final <- alive_stage[i_max]
alive_path        <- alive_files[i_max]

message("Using alive mask: ", basename(alive_path),
        " (stage ", alive_stage_final, ")")

alive_mask <- rast(alive_path)

## 2. Locate frag + distance masks for the same stage -----------------

stage_str <- sprintf("%04d", alive_stage_final)

frag_files <- list.files(
  path_outputs,
  pattern   = paste0("^removed_mask_fragmentation_stage_", stage_str, "\\.tif$"),
  full.names = TRUE
)

dist_files <- list.files(
  path_outputs,
  pattern   = paste0("^removed_mask_distance_stage_", stage_str, "\\.tif$"),
  full.names = TRUE
)

frag_mask <- if (length(frag_files)) rast(frag_files[1]) else NULL
dist_mask <- if (length(dist_files)) rast(dist_files[1]) else NULL

if (is.null(frag_mask) && is.null(dist_mask)) {
  stop("No fragmentation or distance masks found for final stage ", alive_stage_final, ".")
}

## 3. Build combined removal mask (frag + dist) -----------------------

rm_list <- list()
if (!is.null(frag_mask)) rm_list[[length(rm_list) + 1L]] <- frag_mask
if (!is.null(dist_mask)) rm_list[[length(rm_list) + 1L]] <- dist_mask

rm_stack <- do.call(c, rm_list)  # stack the rasters

rm_mask <- if (nlyr(rm_stack) == 1L) {
  rm_stack
} else {
  app(rm_stack, fun = "sum", na.rm = TRUE)
}

# Ensure geometries match
if (!compareGeom(alive_mask, rm_mask, stopOnError = FALSE)) {
  stop("Geometry mismatch between alive mask and frag/dist masks.")
}

## 4. Exclude all cells flagged in frag/dist masks --------------------

alive_vals <- values(alive_mask, mat = TRUE)[, 1]
rm_vals    <- values(rm_mask,    mat = TRUE)[, 1]

# Any cell where rm_mask > 0 is considered removed and should be NA in alive mask
alive_vals[!is.na(rm_vals) & rm_vals > 0] <- NA_integer_

alive_mask_fixed <- setValues(alive_mask, alive_vals)

## 5. Backup original & overwrite with corrected alive mask -----------

bak_path <- paste0(alive_path, ".bak")
if (!file.exists(bak_path)) {
  file.copy(alive_path, bak_path, overwrite = FALSE)
  message("Backed up original alive mask to: ", bak_path)
}

writeRaster(alive_mask_fixed, alive_path, overwrite = TRUE)
message("Corrected alive mask written to: ", alive_path)
```

```{r}
## -------------------------------------------------------------------
## Ultra-fast removal-order raster + map (equal-area cells)
##   - Removal order = cumulative removed CELLS / total initial CELLS
##   - Initial state = all removal masks + final alive mask (latest)
##   - Caches ts + baseline_total_cells to Spatial/removal_order_meta.rds
## -------------------------------------------------------------------
library(terra)
library(data.table)
library(ggplot2)
library(sf)
library(viridis)
library(rnaturalearth)
library(tidyterra)
library(grid)

path_spatial  <- "Spatial"
path_outputs  <- file.path(path_spatial, "Outputs")
meta_path     <- file.path(path_spatial, "removal_order_meta.rds")

terraOptions(memfrac = 0.7)

## -------------------------------------------------------------------
## Try to load cached metadata (ts + baseline_total_cells)
## -------------------------------------------------------------------

if (file.exists(meta_path) && file.exists(file.path(path_outputs, "removed_order.tif"))) {
  message("[cache] Loading cached removal-order metadata from: ", meta_path)

  meta <- readRDS(meta_path)

  if (!all(c("ts", "baseline_total_cells") %in% names(meta))) {
    stop("Cached removal_order_meta.rds does not contain 'ts' and 'baseline_total_cells'. ",
         "Delete it and rerun this chunk to rebuild.")
  }

  ts <- meta$ts
  baseline_total_cells <- meta$baseline_total_cells

  if (!is.data.table(ts)) {
    stop("'ts' loaded from cache is not a data.table. ",
         "Delete Spatial/removal_order_meta.rds and rerun this chunk.")
  }

  message("[cache] Successfully restored ts (", nrow(ts), " rows) and baseline_total_cells = ",
          baseline_total_cells)

} else {

  ## -----------------------------------------------------------------
  ## 1. Locate removal masks + final alive mask ----------------------
  ## -----------------------------------------------------------------

  message("[1/4] Locating removal and alive masks...")

  all_tifs <- list.files(path_outputs, pattern = "\\.tif$", full.names = TRUE)
  bn_all   <- basename(all_tifs)

  rm_mask <-
    grepl("^removed_mask_pruning_stage_\\d+_iter_\\d+\\.tif$", bn_all) |
    grepl("^removed_mask_fragmentation_stage_\\d+\\.tif$",     bn_all) |
    grepl("^removed_mask_distance_stage_\\d+\\.tif$",          bn_all)

  alive_mask_idx <- grepl("^alive_mask_pruning_stage_\\d+_iter_\\d+_final\\.tif$", bn_all)

  if (!any(rm_mask)) {
    stop("No pruning/fragmentation/distance masks found in Spatial/Outputs.")
  }
  if (!any(alive_mask_idx)) {
    stop("No final alive mask found in Spatial/Outputs.")
  }

  # Latest alive mask (highest stage index)
  alive_files <- all_tifs[alive_mask_idx]
  alive_bn    <- basename(alive_files)
  alive_stage <- as.integer(
    sub("alive_mask_pruning_stage_(\\d+)_iter_\\d+_final\\.tif", "\\1", alive_bn)
  )
  alive_final_idx  <- which.max(alive_stage)
  alive_path_final <- alive_files[alive_final_idx]

  # All masks for removal-order calculations
  tif_files <- c(all_tifs[rm_mask], alive_path_final)
  bn        <- basename(tif_files)

  n_masks <- length(tif_files)
  message("  Found ", n_masks, " masks (removals + final alive).")

  ## -----------------------------------------------------------------
  ## 2. Metadata + ordering info -------------------------------------
  ## -----------------------------------------------------------------

  message("[2/4] Building metadata and temporal ordering...")

  ts <- data.table(
    file = bn,
    path = tif_files
  )

  # Type
  ts[, type := fifelse(grepl("^removed_mask_pruning_stage_",        file), "step",
                fifelse(grepl("^removed_mask_fragmentation_stage_", file), "frag",
                fifelse(grepl("^removed_mask_distance_stage_",      file), "dist",
                fifelse(grepl("^alive_mask_pruning_stage_",         file), "final",
                        NA_character_))))]

  # Indices
  ts[, `:=`(s = NA_integer_, i = NA_integer_, k = NA_integer_)]

  ts[type == "step", `:=`(
    s = as.integer(sub("removed_mask_pruning_stage_(\\d+)_iter_\\d+\\.tif", "\\1", file)),
    i = as.integer(sub("removed_mask_pruning_stage_\\d+_iter_(\\d+)\\.tif", "\\1", file))
  )]

  ts[type == "frag",
     k := as.integer(sub("removed_mask_fragmentation_stage_(\\d+)\\.tif", "\\1", file))]

  ts[type == "dist",
     k := as.integer(sub("removed_mask_distance_stage_(\\d+)\\.tif",      "\\1", file))]

  ts[type == "final",
     s := as.integer(sub("alive_mask_pruning_stage_(\\d+)_iter_\\d+_final\\.tif", "\\1", file))]

  ts[, stage := fifelse(!is.na(s), s, k)]

  ## -----------------------------------------------------------------
  ## 3. Read stack + per-mask cell counts (equal-area) ---------------
  ## -----------------------------------------------------------------

  message("[3/4] Reading raster stack (", n_masks, " layers)...")
  r_stack <- rast(ts$path)

  message("[3/4] Computing per-mask cell counts (equal-area, 0% done)...")
  # 1/NA masks â†’ count non-NA cells per layer in one pass
  non_na_counts <- global(!is.na(r_stack), fun = "sum", na.rm = TRUE)[, 1]
  ts[, cells := as.numeric(non_na_counts)]
  message("[3/4] Computing per-mask cell counts (100% done, ",
          n_masks, " masks processed).")

  baseline_total_cells <- sum(ts$cells, na.rm = TRUE)
  message("  Total initial habitat (cells): ", baseline_total_cells)

  ## Temporal order
  ts[, ord := NA_real_]
  ts[type == "step",  ord := s * 1e6 + i]
  ts[type %in% c("frag", "dist"),
     ord := stage * 1e6 + 5e5]
  max_ord <- max(ts$ord, na.rm = TRUE)
  ts[type == "final", ord := max_ord + 1e6]

  setorder(ts, ord)

  ## Step groups (frag + dist with same stage share a group) ---------

  n <- nrow(ts)
  is_fd <- ts$type %in% c("frag", "dist")

  # same_step[j] = TRUE iff j>1 and (j, j-1) are both frag/dist of same stage
  same_step <- rep(FALSE, n)
  if (n > 1) {
    idx <- 2:n
    same_step[idx] <- is_fd[idx] & is_fd[idx - 1] &
      !is.na(ts$stage[idx]) & !is.na(ts$stage[idx - 1]) &
      ts$stage[idx] == ts$stage[idx - 1]
  }

  ts[, step_group := cumsum(!same_step)]

  # Cumulative removed cells at start of each step group
  step_totals <- ts[, .(step_cells = sum(cells, na.rm = TRUE)), by = step_group]
  step_totals[, cum_cells_start := shift(cumsum(step_cells), fill = 0)]

  ts[step_totals, cum_cells_start := i.cum_cells_start, on = "step_group"]
  ts[, cum_removed_prop := cum_cells_start / baseline_total_cells]

  ## -----------------------------------------------------------------
  ## 4. Build removal-order raster -----------------------------------
  ## -----------------------------------------------------------------

  message("[4/4] Building removal-order raster...")

  # Ensure weights align with r_stack layer order
  w_stack_order <- ts[match(basename(tif_files), ts$file), cum_removed_prop]

  removed_path <- file.path(path_outputs, "removed_order.tif")

  message("  Writing ", removed_path, " ...")
  removed_order <- sum(
    r_stack * w_stack_order,
    na.rm    = TRUE,
    filename = removed_path,
    overwrite = TRUE
  )
  names(removed_order) <- "removed_order"
  message("  Done writing removal-order raster.")

  ## -----------------------------------------------------------------
  ## Save metadata (ts + baseline_total_cells) for later sessions ----
  ## -----------------------------------------------------------------

  meta <- list(
    ts                  = ts,
    baseline_total_cells = baseline_total_cells
  )

  saveRDS(meta, meta_path)
  message("Saved removal-order metadata (ts + baseline_total_cells) to: ", meta_path)
}
```

```{r}
library(terra)
library(sf)
library(ggplot2)
library(tidyterra)
library(rnaturalearth)

path_spatial <- "Spatial"
path_outputs <- file.path(path_spatial, "Outputs")

## =========================
## 1. Load removal-order raster
## =========================

removed_order <- rast(file.path(path_outputs, "removed_order.tif"))
names(removed_order) <- "removed_order"

## =========================
## 2. Madagascar border
## =========================

mg <- ne_countries(
  country     = "Madagascar",
  scale       = "medium",
  returnclass = "sf"
)
mg <- st_transform(mg, crs = crs(removed_order, proj = TRUE))

## =========================
## 3. Map helpers (as in your other figures)
## =========================

theme_map <- theme_void(base_size = 9) +
  theme(
    plot.title = element_text(
      hjust  = 0.5,
      size   = 12,
      face   = "bold",
      margin = margin(b = 4)
    ),
    plot.title.position = "plot",
    plot.margin  = margin(3, 3, 3, 3),
    panel.border = element_rect(color = "grey20", fill = NA, linewidth = 0.3),
    legend.position   = "right",
    legend.title      = element_text(size = 9, face = "bold"),
    legend.text       = element_text(size = 8),
    legend.background = element_rect(fill = "white", colour = NA)
  )

coord_map <- function(r) {
  coord_sf(crs = crs(r, proj = TRUE), expand = FALSE)
}

add_mg <- function() {
  geom_sf(
    data        = mg,
    fill        = NA,
    color       = "grey10",
    linewidth   = 0.35,
    inherit.aes = FALSE
  )
}

## =========================
## 4. Removal-order map (plasma)
## =========================

p_removed_order <- ggplot() +
  geom_spatraster(data = removed_order, na.rm = TRUE) +
  add_mg() +
  scale_fill_viridis_c(
    option    = "plasma",
    name      = "Removal order\n(proportion of initial\nhabitat area lost)",
    limits    = c(0, 1),
    breaks    = c(0.00, 0.25, 0.50, 0.75, 1.00),
    labels    = c("0.00", "0.25", "0.50", "0.75", "1.00"),
    na.value  = "white"
  ) +
  coord_map(removed_order) +
  ggtitle("Removal order across planning units") +
  theme_map

p_removed_order

## =========================
## 5. Save figure (+ optional cached ggplot object)
## =========================

out_fig <- file.path(path_outputs, "figure_removed_order_map.png")
ggsave(
  filename = out_fig,
  plot     = p_removed_order,
  width    = 90,   # mm
  height   = 110,  # mm
  units    = "mm",
  dpi      = 600
)

# Optional: save the ggplot object itself for quick reuse
saveRDS(
  p_removed_order,
  file.path(path_spatial, "removed_order_map_ggplot.rds")
)

message("Saved removal-order map figure to: ", out_fig)
message("Saved ggplot object to: Spatial/removed_order_map_ggplot.rds")
```

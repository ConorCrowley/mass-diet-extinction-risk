---
title: "SpatialFigures"
output: html_document
---

```{r}
library(fasterRaster)  
faster(grassDir = "C:/Program Files/GRASS GIS 8.4")
```

```{r}
## ============================================
## C. ferox: AOH, patches, and population units
## Outputs (all SpatRaster, aligned to masks/template):
##   1) cryptoprocta_ferox_range_300m.tif       (baseline range, 1/NA)
##   2) cryptoprocta_ferox_aoh_300m.tif         (habitat-filtered AOH, 1/NA)
##   3) cryptoprocta_ferox_patches_pre.tif      (patch IDs before min patch filter)
##   4) cryptoprocta_ferox_patches_post.tif     (patch IDs after min patch filter)
##   5) cryptoprocta_ferox_units_pre.tif        (PU IDs before 500-individual filter)
##   6) cryptoprocta_ferox_units_post.tif       (PU IDs after 500-individual filter)
## ============================================

library(terra)
library(dplyr)
library(fasterRaster)
library(sf)
library(igraph)
library(tools)

## ---------------------------
## 1. Load species row & masks
## ---------------------------

species_df <- read.csv("Data/Clean/mammal_data.csv")

# Standardize name format to match rasters
species_df <- species_df |>
  mutate(scientific_resolved = tolower(gsub(" ", "_", scientific_resolved)))

cf <- species_df |>
  filter(scientific_resolved == "cryptoprocta_ferox") |>
  slice(1)

if (nrow(cf) != 1) {
  stop("Could not find a unique row for Cryptoprocta ferox in MammalData.csv")
}

# Load mask stack (ESA CCI-based habitat layers, already ROI & aligned)
masks    <- terra::rast("Spatial/masks.tif")
template <- masks[[1]]  # common working grid

## ---------------------------
## 2. Build C. ferox habitat mask (IUCN x ESA CCI)
## ---------------------------

habitat_map <- c(
  "Forest"                                           = "forest",
  "Savanna"                                          = "savanna",
  "Shrubland"                                        = "shrubland",
  "Grassland"                                        = "grassland",
  "Wetlands (inland)"                                = "wetlands",
  "Rocky Areas (e.g., inland cliffs, mountain peaks)"= "rocky_areas",
  "Desert"                                           = "desert",
  "Arable & Pastureland"                             = "artificial_arable_pasture",
  "Plantations & Heavily Degraded Former Forest"     = "artificial_degraded_forest_plantation",
  "Urban & Rural Gardens"                            = "artificial_urban_rural_gardens",
  "Artificial - Aquatic"                             = "artificial_aquatic"
)

valid_mask_layers <- names(masks)

hraw <- cf$habitats_mixed[1]
lbls <- if (is.na(hraw)) character(0) else trimws(strsplit(hraw, ",")[[1]])

mask_names <- unname(habitat_map[lbls])
mask_names <- mask_names[!is.na(mask_names)]
mask_names <- unique(mask_names[mask_names %in% valid_mask_layers])

if (length(mask_names) == 0L) {
  stop("No valid habitat mask layers for C. ferox after crosswalk.")
}

# Union of suitable habitat layers → 1 (suitable), NA (unsuitable / outside)
cf_hab_union <- if (length(mask_names) == 1L) {
  masks[[mask_names]]
} else {
  u <- terra::app(masks[[mask_names]], fun = sum, na.rm = TRUE)
  terra::ifel(u > 0, 1, NA)
}
names(cf_hab_union) <- "cf_hab_mask"

## ---------------------------
## 3. Baseline range raster for C. ferox on template grid
## ---------------------------

ppm_files <- list.files("Spatial/mammal_ppm_bin", pattern = "\\.tif$", full.names = TRUE)
if (!length(ppm_files)) stop("No PPM rasters found in Spatial/mammal_ppm_bin")

ppm_names <- tolower(sub("_bin$", "", file_path_sans_ext(basename(ppm_files))))
idx <- which(ppm_names == cf$scientific_resolved[1])

if (length(idx) != 1) {
  stop("Could not uniquely match Cryptoprocta ferox PPM raster.")
}

cf_ppm_native <- terra::rast(ppm_files[idx])

# Align to template using nearest neighbor to preserve 0/1/NA
cf_range_300m <- terra::project(cf_ppm_native, template, method = "near")

# Enforce strict 1 / NA baseline range (no zeros)
cf_range_300m[cf_range_300m <= 0] <- NA
cf_range_300m[cf_range_300m > 0]  <- 1
names(cf_range_300m) <- "cf_range_300m"

terra::writeRaster(
  cf_range_300m,
  "Spatial/cryptoprocta_ferox_range_300m.tif",
  overwrite = TRUE
)

## ---------------------------
## 4. Habitat-filtered AOH (range ∩ habitat)
## ---------------------------

cf_aoh_300m <- cf_hab_union * cf_range_300m
cf_aoh_300m[cf_aoh_300m <= 0] <- NA
cf_aoh_300m[cf_aoh_300m > 0]  <- 1
names(cf_aoh_300m) <- "cf_aoh_300m"

terra::writeRaster(
  cf_aoh_300m,
  "Spatial/cryptoprocta_ferox_aoh_300m.tif",
  overwrite = TRUE
)

## These two rasters give you Figure fossa_aoh (baseline vs AOH).

## ---------------------------
## 5. Patch IDs before & after min patch-size filter
## ---------------------------

# Initialize fasterRaster backend (adjust path to your GRASS install)
fasterRaster::faster(grassDir = "C:/Program Files/GRASS GIS 8.4")

# Work on trimmed extent for speed
cf_suit_trim <- terra::trim(cf_aoh_300m)

# Rook adjacency (4-direction) clumps
cf_clump_fast        <- fasterRaster::clump(fasterRaster::fast(cf_suit_trim), diagonal = FALSE)
cf_patches_pre_trim  <- terra::rast(cf_clump_fast)
names(cf_patches_pre_trim) <- "patch_id"

# Extend back to full template extent
cf_patches_pre <- terra::extend(cf_patches_pre_trim, cf_aoh_300m)
names(cf_patches_pre) <- "patch_id"

terra::writeRaster(
  cf_patches_pre,
  "Spatial/cryptoprocta_ferox_patches_pre.tif",
  overwrite = TRUE
)

# Compute patch areas (km^2)
cell_area_km <- terra::cellSize(cf_suit_trim, unit = "km")
area_tab <- terra::zonal(cell_area_km, cf_patches_pre_trim, fun = "sum", na.rm = TRUE) |>
  as.data.frame()
colnames(area_tab) <- c("patch_id", "area_km2")

# Species-specific min patch size (should be 10 / D_s) from your table
Amin_patch_cf <- cf$min_patch_size[1]
if (is.na(Amin_patch_cf)) stop("min_patch_size missing for C. ferox")

keep_ids <- area_tab$patch_id[area_tab$area_km2 >= Amin_patch_cf]
if (!length(keep_ids)) stop("No C. ferox patches ≥ min_patch_size.")

# Reindex kept patches to 1..n for clarity
rcl_keep <- cbind(keep_ids, seq_along(keep_ids))

cf_patches_post_trim <- terra::classify(
  cf_patches_pre_trim,
  rcl = rcl_keep,
  others = NA,
  include.lowest = TRUE
)
names(cf_patches_post_trim) <- "patch_id"

cf_patches_post <- terra::extend(cf_patches_post_trim, cf_aoh_300m)
names(cf_patches_post) <- "patch_id"

terra::writeRaster(
  cf_patches_post,
  "Spatial/cryptoprocta_ferox_patches_post.tif",
  overwrite = TRUE
)

## cf_patches_pre vs cf_patches_post → Figure fossa_patches.

## ---------------------------
## 6. Population units: before & after 500-individual filter
## ---------------------------

sf::sf_use_s2(TRUE)

# Polygons for filtered patches (each patch_id -> one polygon)
patch_poly <- terra::as.polygons(
  cf_patches_post,
  values   = TRUE,
  dissolve = TRUE,
  na.rm    = TRUE
)

# Keep only valid patches
patch_poly <- patch_poly[!is.na(patch_poly$patch_id), ]
patch_poly$patch_id <- as.integer(patch_poly$patch_id)

# To sf for distance-based clustering
patches_sf <- sf::st_as_sf(patch_poly)

# Dispersal distance threshold (km -> m)
delta_cf_km <- cf$dispersal_dist[1]
if (is.na(delta_cf_km)) stop("dispersal_dist missing for C. ferox")
dist_thresh_m <- delta_cf_km * 1000

# Neighbor list: indices of patches within dispersal distance
nb <- sf::st_is_within_distance(
  patches_sf,
  patches_sf,
  dist = dist_thresh_m
)

# Build graph from adjacency list:
# - use mode = "all" to create (potentially) bidirectional edges
# - then coerce to undirected and simplify
g <- igraph::graph_from_adj_list(nb, mode = "all")
g <- igraph::as.undirected(g, mode = "collapse")
g <- igraph::simplify(g, remove.multiple = TRUE, remove.loops = TRUE)

# Connected components = provisional population units
comp <- igraph::components(g)$membership
patches_sf$unit_id_pre <- as.integer(factor(comp))

# Raster of provisional population units on the same grid
patch_poly_units <- terra::vect(patches_sf)
cf_units_pre <- terra::rasterize(
  patch_poly_units,
  cf_patches_post,
  field = "unit_id_pre"
)
names(cf_units_pre) <- "unit_id"

terra::writeRaster(
  cf_units_pre,
  "Spatial/cryptoprocta_ferox_units_pre.tif",
  overwrite = TRUE
)

# --- Apply 500-individual minimum unit size ---

# Area per patch (km^2)
patch_poly_units$area_km2 <- terra::expanse(patch_poly_units, unit = "km")

# Get attributes as data.frame; keep only relevant columns
patch_df <- as.data.frame(patch_poly_units)[
  , c("patch_id", "unit_id_pre", "area_km2")
]

unit_area <- stats::aggregate(area_km2 ~ unit_id_pre, data = patch_df, sum)
colnames(unit_area) <- c("unit_id_pre", "unit_area_km2")

# Threshold area corresponding to 500 individuals (500 / D_s)
Amin_unit_cf <- cf$min_patch_size500[1]
if (is.na(Amin_unit_cf)) stop("min_patch_size500 missing for C. ferox")

keep_units <- unit_area$unit_id_pre[unit_area$unit_area_km2 >= Amin_unit_cf]

if (!length(keep_units)) {
  warning("No population units ≥ 500-individual threshold for C. ferox.")
}

# Mark kept units and reindex to 1..n_kept
patch_poly_units$unit_id_post <- ifelse(
  patch_poly_units$unit_id_pre %in% keep_units,
  patch_poly_units$unit_id_pre,
  NA
)

valid_units <- sort(unique(na.omit(patch_poly_units$unit_id_post)))

if (length(valid_units) > 0) {
  id_map <- data.frame(
    unit_id_post       = valid_units,
    unit_id_post_reidx = seq_along(valid_units)
  )
  patch_poly_units$unit_id_post_reidx <- id_map$unit_id_post_reidx[
    match(patch_poly_units$unit_id_post, id_map$unit_id_post)
  ]
} else {
  patch_poly_units$unit_id_post_reidx <- NA_integer_
}

cf_units_post <- terra::rasterize(
  patch_poly_units,
  cf_patches_post,
  field = "unit_id_post_reidx"
)
names(cf_units_post) <- "unit_id"

terra::writeRaster(
  cf_units_post,
  "Spatial/cryptoprocta_ferox_units_post.tif",
  overwrite = TRUE
)
```

```{r}
library(terra)
library(sf)
library(ggplot2)
library(tidyterra)
library(patchwork)
library(rnaturalearth)

## =========================
## 0. Load prepared rasters
## =========================

cf_range <- rast("Spatial/cryptoprocta_ferox_range_300m.tif")
cf_aoh   <- rast("Spatial/cryptoprocta_ferox_aoh_300m.tif")

cf_patches_pre  <- rast("Spatial/cryptoprocta_ferox_patches_pre.tif")
cf_patches_post <- rast("Spatial/cryptoprocta_ferox_patches_post.tif")

cf_units_pre  <- rast("Spatial/cryptoprocta_ferox_units_pre.tif")
cf_units_post <- rast("Spatial/cryptoprocta_ferox_units_post.tif")

## ==========================================
## 1. Madagascar border
## ==========================================

mg <- ne_countries(
  country = "Madagascar",
  scale   = "medium",
  returnclass = "sf"
)
mg <- st_transform(mg, crs = crs(cf_range, proj = TRUE))

## ==========================================
## 2. Shared theme, coord & helpers
## ==========================================

theme_map <- theme_void(base_size = 9) +
  theme(
    plot.title = element_text(
      hjust  = 0.5,
      size   = 11.5,
      face   = "bold",
      margin = margin(b = 4)
    ),
    plot.title.position = "plot",
    plot.margin  = margin(3, 3, 3, 3),
    panel.border = element_rect(color = "grey20", fill = NA, linewidth = 0.3)
  )

coord_map <- function(r) {
  crs_obj <- crs(r, proj = TRUE)
  coord_sf(crs = crs_obj, expand = FALSE)
}

add_mg <- function() {
  geom_sf(
    data        = mg,
    fill        = NA,
    color       = "grey10",
    linewidth   = 0.35,
    inherit.aes = FALSE
  )
}

## ==========================================
## 4. Figure: Patches pre/post min patch size
## ==========================================

cf_patches_pre_f  <- as.factor(cf_patches_pre)
cf_patches_post_f <- as.factor(cf_patches_post)

p_patches_pre <- ggplot() +
  geom_spatraster(data = cf_patches_pre_f, na.rm = TRUE) +
  add_mg() +
  scale_fill_viridis_d(guide = "none", na.translate = FALSE) +
  coord_map(cf_patches_pre_f) +
  ggtitle("(a) Patches (no filter)") +
  theme_map

p_patches_post <- ggplot() +
  geom_spatraster(data = cf_patches_post_f, na.rm = TRUE) +
  add_mg() +
  scale_fill_viridis_d(guide = "none", na.translate = FALSE) +
  coord_map(cf_patches_post_f) +
  ggtitle("(b) Patches ≥ 10 ind.") +
  theme_map

## ==========================================
## 5. Figure: Units pre/post 500-individual filter
## ==========================================

cf_units_pre_f  <- as.factor(cf_units_pre)
cf_units_post_f <- as.factor(cf_units_post)

p_units_pre <- ggplot() +
  geom_spatraster(data = cf_units_pre_f, na.rm = TRUE) +
  add_mg() +
  scale_fill_viridis_d(guide = "none", na.translate = FALSE) +
  coord_map(cf_units_pre_f) +
  ggtitle("(c) Pop. units (no filter)") +
  theme_map

p_units_post <- ggplot() +
  geom_spatraster(data = cf_units_post_f, na.rm = TRUE) +
  add_mg() +
  scale_fill_viridis_d(guide = "none", na.translate = FALSE) +
  coord_map(cf_units_post_f) +
  ggtitle("(d) Pop. units ≥ 500 ind.") +
  theme_map

## ==========================================
## Combined 4-panel figure: patches + units
## ==========================================

fig_fossa_patches_units <- p_patches_pre +
  p_patches_post +
  p_units_pre +
  p_units_post +
  plot_layout(ncol = 4)

fig_fossa_patches_units
```


```{r}
library(terra)
library(sf)
library(ggplot2)
library(tidyterra)
library(patchwork)
library(rnaturalearth)

## =========================
## 0. Load data
## =========================

cf_range <- rast("Spatial/cryptoprocta_ferox_range_300m.tif")
cf_aoh   <- rast("Spatial/cryptoprocta_ferox_aoh_300m.tif")
masks    <- rast("Spatial/masks.tif")
forest   <- masks[["forest"]]
if (is.null(forest)) stop("No 'forest' layer in masks.tif")

## =========================
## 1. Map helpers
## =========================

mg <- ne_countries(
  country = "Madagascar",
  scale   = "medium",
  returnclass = "sf"
)
mg <- st_transform(mg, crs = crs(cf_range, proj = TRUE))

theme_map <- theme_void(base_size = 9) +
  theme(
    plot.title = element_text(
      hjust  = 0.5,
      size   = 12,
      face   = "bold",
      margin = margin(b = 4)
    ),
    plot.title.position = "plot",
    plot.margin  = margin(3, 3, 3, 3),
    panel.border = element_rect(color = "grey20", fill = NA, linewidth = 0.3)
  )

coord_map <- function(r) {
  coord_sf(crs = crs(r, proj = TRUE), expand = FALSE)
}

add_mg <- function() {
  geom_sf(
    data        = mg,
    fill        = NA,
    color       = "grey10",
    linewidth   = 0.35,
    inherit.aes = FALSE
  )
}

## =========================
## 2. Bin rasters for plotting
## =========================

# Baseline: 1/0
range_bin <- cf_range
range_bin[range_bin > 0]  <- 1
range_bin[range_bin <= 0] <- 0

# Forest: 1/0
forest_bin <- forest
forest_bin[forest_bin > 0]  <- 1
forest_bin[forest_bin <= 0] <- 0

# AOH: 1/0
aoh_bin <- cf_aoh
aoh_bin[aoh_bin > 0]  <- 1
aoh_bin[aoh_bin <= 0] <- 0

## =========================
## 3. Three plots
## =========================

# (a) Baseline distribution
p_range <- ggplot() +
  geom_spatraster(data = range_bin) +
  add_mg() +
  scale_fill_gradient(
    low      = "#7F7F7F",
    high     = "#7F7F7F",
    na.value = "white",
    guide    = "none"
  ) +
  coord_map(range_bin) +
  ggtitle("(a) Species range") +
  theme_map

# (b) Habitat mask (forest)
p_mask <- ggplot() +
  geom_spatraster(data = forest_bin) +
  add_mg() +
  scale_fill_gradient(
    low      = "#8FB996",
    high     = "#8FB996",
    na.value = "white",
    guide    = "none"
  ) +
  coord_map(forest_bin) +
  ggtitle("(b) Species habitat") +
  theme_map

# (c) Habitat-filtered distribution (AOH)
p_aoh <- ggplot() +
  geom_spatraster(data = aoh_bin) +
  add_mg() +
  scale_fill_gradient(
    low      = "#335C67",
    high     = "#335C67",
    na.value = "white",
    guide    = "none"
  ) +
  coord_map(aoh_bin) +
  ggtitle("(c) Sp. range & habitat") +
  theme_map

## =========================
## 4. Arrange with gaps
## =========================
## layout: plot, gap, plot, gap, plot
## gaps are half the width of plots

fig_fossa_aoh <- p_range +
  plot_spacer() +
  p_mask +
  plot_spacer() +
  p_aoh +
  plot_layout(widths = c(1, 0.5, 1, 0.5, 1))

fig_fossa_aoh
```

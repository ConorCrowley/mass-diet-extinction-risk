---
title: "spatial_prioritization_analysis"
output: html_document
---

```{r}
## ============================================================
## 2. PU metrics over stages (+ habitat loss, equal-area)
##    - Number of individuals, expected individuals, persistence
##    - Habitat loss (%) based on CELL COUNTS from removal-order script
##    - Uses: Spatial/removal_order_meta.rds (ts + baseline_total_cells)
## ============================================================

library(data.table)
library(ggplot2)

## ------------------------------------------------------------
## 2.1 Paths and basic checks
## ------------------------------------------------------------

path_spatial  <- "Spatial"
path_outputs  <- file.path(path_spatial, "Outputs")
init_rds_path <- file.path(path_spatial, "global_orchestrator_init.rds")
meta_path     <- file.path(path_spatial, "removal_order_meta.rds")

if (!file.exists(init_rds_path)) {
  stop("Cannot find 'Spatial/global_orchestrator_init.rds'. ",
       "Make sure you ran the init script and saved orchestrator_init there.")
}

## ------------------------------------------------------------
## 2.2 Load initial (stage 0) state and params
## ------------------------------------------------------------

init_state <- readRDS(init_rds_path)

if (!all(c("params", "patch_dt") %in% names(init_state))) {
  stop("The init RDS must contain 'params' and 'patch_dt'.")
}

params     <- as.data.table(init_state$params)
patch_dt_0 <- as.data.table(init_state$patch_dt)

needed_param_cols <- c("species", "density", "a_pred", "b_pred", "min_patch_size500")
needed_patch_cols <- c("species", "patch_id", "pu_id", "patch_area_km2")

if (!all(needed_param_cols %in% names(params))) {
  stop("params must contain columns: ", paste(needed_param_cols, collapse = ", "), ".")
}
if (!all(needed_patch_cols %in% names(patch_dt_0))) {
  stop("patch_dt_0 must contain columns: ", paste(needed_patch_cols, collapse = ", "), ".")
}

setkey(params, species)

neutral_blue <- "#3A6FB0"

theme_clean <- function(base_size = 12) {
  theme_minimal(base_size = base_size) +
    theme(
      axis.title         = element_text(face = "bold"),
      axis.text          = element_text(color = "grey20"),
      panel.grid.minor   = element_blank(),
      panel.grid.major.x = element_blank(),
      panel.grid.major.y = element_line(color = "grey90"),
      panel.border       = element_rect(color = "grey60", fill = NA, linewidth = 0.6),
      plot.title         = element_text(face = "bold"),
      legend.position    = "none",
      plot.margin        = margin(6, 6, 6, 6)
    )
}

## ------------------------------------------------------------
## 2.3 Helper: per-species metrics from patch_dt
## ------------------------------------------------------------

compute_species_metrics <- function(patch_dt, params_dt) {
  patch_dt <- as.data.table(patch_dt)

  if (!nrow(patch_dt)) {
    return(data.table(
      species              = character(),
      weighted_pu_count    = numeric(),
      weighted_expected_pu = numeric(),
      species_persistence  = numeric()
    ))
  }

  # PU-level areas per species Ã— PU
  pu_dt <- patch_dt[
    ,
    .(pu_area_km2 = sum(patch_area_km2)),
    by = .(species, pu_id)
  ]

  # Join species-level params
  pu_data <- params_dt[pu_dt, on = .(species)]

  A    <- pu_data$pu_area_km2
  dens <- pu_data$density
  a    <- pu_data$a_pred
  b    <- pu_data$b_pred
  c_th <- pu_data$min_patch_size500

  if (any(!is.finite(A))) {
    stop("Non-finite PU areas encountered.")
  }

  delta <- A - c_th
  bad   <- !is.finite(delta) | delta <= 0

  # Default P_i = 0
  P_i <- numeric(length(A))
  P_i[] <- 0

  ok <- !bad
  if (any(ok)) {
    log_a2_ok <- log(a[ok]) - b[ok] * log(dens[ok])
    y_ok      <- log_a2_ok - b[ok] * log(delta[ok])
    e_y_ok    <- exp(y_ok)
    P_i_ok    <- exp(-e_y_ok)

    P_i_ok[!is.finite(P_i_ok) | P_i_ok < 0] <- 0
    P_i_ok[P_i_ok > 1] <- 1

    P_i[ok] <- P_i_ok
  }

  # Individuals per PU
  N_i <- dens * A
  N_i[!is.finite(N_i) | N_i < 0] <- 0

  pu_data[, `:=`(
    N_i = N_i,
    P_i = P_i
  )]

  metrics <- pu_data[
    ,
    .(
      weighted_pu_count    = sum(N_i, na.rm = TRUE),
      weighted_expected_pu = sum(N_i * P_i, na.rm = TRUE),
      species_persistence  = 1 - prod(1 - P_i, na.rm = TRUE)
    ),
    by = species
  ]

  metrics[!is.finite(species_persistence) | species_persistence < 0,
          species_persistence := 0]
  metrics[species_persistence > 1, species_persistence := 1]

  metrics
}

## ------------------------------------------------------------
## 2.4 Baseline (stage 0): species set and baseline counts
## ------------------------------------------------------------

m0_raw <- compute_species_metrics(patch_dt_0, params)

baseline <- m0_raw[
  weighted_pu_count > 0,
  .(species, baseline_weighted_count = weighted_pu_count)
]

if (!nrow(baseline)) {
  stop("No species with positive baseline weighted_pu_count at stage 0.")
}

setkey(baseline, species)

## Small helper: given patch_dt and stage, return metrics for all baseline species
process_stage <- function(patch_dt, stage_id) {
  mk_raw <- compute_species_metrics(patch_dt, params)

  # Merge onto baseline species (ensures same species set for ALL stages)
  mk <- merge(
    baseline,
    mk_raw,
    by   = "species",
    all.x = TRUE
  )

  # Species with no PUs at this stage => NA metrics -> treat as 0 (extinct)
  for (col in c("weighted_pu_count", "weighted_expected_pu", "species_persistence")) {
    mk[is.na(get(col)), (col) := 0]
  }

  mk[, `:=`(
    stage               = stage_id,
    pct_weighted_count  = 100 * weighted_pu_count    / baseline_weighted_count,
    pct_weighted_exp    = 100 * weighted_expected_pu / baseline_weighted_count,
    species_persist_pct = 100 * species_persistence
  )]

  mk
}

metrics_list <- list()

## Stage 0
metrics_list[[length(metrics_list) + 1L]] <- process_stage(patch_dt_0, 0L)

## ------------------------------------------------------------
## 2.5 Checkpoint stages (k = 1, 2, ...)
## ------------------------------------------------------------

state_files <- list.files(
  path_outputs,
  pattern    = "^global_state_stage_\\d+\\.rds$",
  full.names = TRUE
)

if (!length(state_files)) {
  stop("No checkpoint RDS files found in 'Spatial/Outputs' with pattern 'global_state_stage_XXXX.rds'.")
}

state_dt <- data.table(
  path = state_files,
  file = basename(state_files)
)

state_dt[, stage := as.integer(sub("global_state_stage_(\\d+)\\.rds", "\\1", file))]
setorder(state_dt, stage)

for (row_idx in seq_len(nrow(state_dt))) {
  stage_i <- state_dt$stage[row_idx]
  st_path <- state_dt$path[row_idx]

  st <- readRDS(st_path)
  if (!"patch_dt" %in% names(st)) {
    stop("Checkpoint file ", st_path, " does not contain 'patch_dt'.")
  }

  patch_dt_k <- as.data.table(st$patch_dt)

  metrics_list[[length(metrics_list) + 1L]] <- process_stage(patch_dt_k, stage_i)
}

## ------------------------------------------------------------
## 2.6 Stack all stages into one table
##    (fixed species set; extinct species => 0 metrics)
## ------------------------------------------------------------

all_metrics <- rbindlist(metrics_list, use.names = TRUE, fill = TRUE)
# Columns include:
#   species, baseline_weighted_count,
#   weighted_pu_count, weighted_expected_pu, species_persistence,
#   pct_weighted_count, pct_weighted_exp, species_persist_pct,
#   stage

## ------------------------------------------------------------
## 2.7 Average across species per stage
## ------------------------------------------------------------

stage_summary <- all_metrics[
  ,
  .(
    avg_pct_weighted_count = mean(pct_weighted_count),
    avg_pct_weighted_exp   = mean(pct_weighted_exp),
    avg_species_persist    = mean(species_persistence)
  ),
  by = stage
][order(stage)]

stage_summary[, avg_persistence_pct := 100 * avg_species_persist]
print(stage_summary)

## ------------------------------------------------------------
## 2.8 Equal-area cumulative habitat-loss (%) per stage
##      (loads ts + baseline_total_cells from meta RDS if needed)
## ------------------------------------------------------------

if (!exists("ts") || !is.data.table(ts) || !exists("baseline_total_cells")) {

  if (!file.exists(meta_path)) {
    stop(
      "Could not find 'ts' and 'baseline_total_cells' in the current session, ",
      "and 'Spatial/removal_order_meta.rds' does not exist.\n",
      "Run the ultra-fast removal-order chunk once to create this file, ",
      "then re-run this analysis chunk."
    )
  }

  meta <- readRDS(meta_path)

  if (!all(c("ts", "baseline_total_cells") %in% names(meta))) {
    stop(
      "Spatial/removal_order_meta.rds does not contain 'ts' and 'baseline_total_cells'.\n",
      "Delete that file and rerun the removal-order chunk to rebuild it."
    )
  }

  ts                   <- meta$ts
  baseline_total_cells <- meta$baseline_total_cells

  if (!is.data.table(ts)) {
    stop(
      "'ts' loaded from Spatial/removal_order_meta.rds is not a data.table.\n",
      "Delete that file and rerun the removal-order chunk."
    )
  }
}

if (!"cells" %in% names(ts)) {
  stop("The 'ts' object has no 'cells' column. ",
       "Make sure you ran the full removal-order script that computes per-mask cell counts.")
}

stage_removed <- ts[
  type %in% c("step", "frag", "dist") & !is.na(stage),
  .(removed_cells = sum(cells, na.rm = TRUE)),
  by = stage
][order(stage)]

stage_removed[, cum_removed_cells := cumsum(removed_cells)]
stage_removed[, loss_pct := 100 * cum_removed_cells / baseline_total_cells]

# Merge loss_pct into stage_summary
stage_summary <- merge(
  stage_summary,
  stage_removed[, .(stage, loss_pct)],
  by = "stage",
  all.x = TRUE,
  sort = FALSE
)

# Stage 0 = 0% loss if missing; forward-fill others
stage_summary[stage == 0 & is.na(loss_pct), loss_pct := 0]
setorder(stage_summary, stage)

last_val <- 0
for (ii in seq_len(nrow(stage_summary))) {
  if (is.na(stage_summary$loss_pct[ii])) {
    stage_summary$loss_pct[ii] <- last_val
  } else {
    last_val <- stage_summary$loss_pct[ii]
  }
}

stage_summary[, remaining_pct := 100 - loss_pct]

## ------------------------------------------------------------
## 2.9 Ensure a full-removal (100% loss) stage with zero metrics
## ------------------------------------------------------------

has_full <- any(stage_summary$loss_pct >= 100 - 1e-6)

if (!has_full) {
  stage_full <- max(stage_summary$stage, na.rm = TRUE) + 1L

  # Add stage 100% loss with zero averages
  stage_summary <- rbind(
    stage_summary,
    data.table(
      stage                  = stage_full,
      avg_pct_weighted_count = 0,
      avg_pct_weighted_exp   = 0,
      avg_species_persist    = 0,
      avg_persistence_pct    = 0,
      loss_pct               = 100,
      remaining_pct          = 0
    ),
    use.names = TRUE,
    fill = TRUE
  )
  setorder(stage_summary, stage)

  # Add per-species zeros at 100% loss
  all_metrics <- rbind(
    all_metrics,
    data.table(
      species               = baseline$species,
      baseline_weighted_count = baseline$baseline_weighted_count,
      weighted_pu_count     = 0,
      weighted_expected_pu  = 0,
      species_persistence   = 0,
      pct_weighted_count    = 0,
      pct_weighted_exp      = 0,
      species_persist_pct   = 0,
      stage                 = stage_full
    ),
    use.names = TRUE,
    fill = TRUE
  )
}

## ---- Save stage_summary to Spatial -----------------------------------

stage_summary_rds <- file.path(path_spatial, "stage_summary.rds")
saveRDS(stage_summary, stage_summary_rds)
message("Saved stage_summary (RDS) to: ", stage_summary_rds)

## Attach loss_pct to all_metrics
all_metrics <- merge(
  all_metrics,
  stage_summary[, .(stage, loss_pct)],
  by = "stage",
  all.x = TRUE,
  sort = FALSE
)

## ------------------------------------------------------------
## 2.10 Average trajectories vs cumulative habitat loss
## ------------------------------------------------------------

plot_df <- melt(
  stage_summary,
  id.vars      = c("stage", "loss_pct"),
  measure.vars = c("avg_pct_weighted_count", "avg_pct_weighted_exp"),
  variable.name = "metric",
  value.name    = "value"
)

plot_df[metric == "avg_pct_weighted_count", metric_label := "Weighted PUs"]
plot_df[metric == "avg_pct_weighted_exp",   metric_label := "Weighted expected PUs"]

p_traj <- ggplot(
  plot_df,
  aes(x = loss_pct, y = value, color = metric_label, group = metric_label)
) +
  geom_line(linewidth = 0.9) +
  geom_point(size = 1.8) +
  scale_x_continuous(
    name   = "Cumulative habitat loss (%)",
    limits = c(0, 100),
    breaks = seq(0, 100, by = 20),
    expand = expansion(mult = c(0, 0.01))
  ) +
  scale_y_continuous(
    name   = "Weighted PUs (%)",
    limits = c(0, 100),
    expand = expansion(mult = c(0, 0.03))
  ) +
  scale_color_manual(
    name   = NULL,
    values = c(
      "Weighted PUs"          = "grey35",
      "Weighted expected PUs" = neutral_blue
    )
  ) +
  ggtitle("Average weighted PUs") +
  theme_clean(base_size = 11) +
  theme(
    plot.title         = element_text(hjust = 0.5, face = "bold"),
    legend.position    = "top",
    legend.margin      = margin(b = 2),
    legend.text        = element_text(size = 9),
    panel.grid.major.x = element_blank(),
    panel.grid.minor   = element_blank()
  )

print(p_traj)

fig_path <- file.path(path_outputs, "figure_weighted_pu_trajectories.png")
ggsave(
  filename = fig_path,
  plot     = p_traj,
  width    = 140,
  height   = 85,
  units    = "mm",
  dpi      = 600
)

message("Saved weighted PU trajectory figure to: ", fig_path)

## ------------------------------------------------------------
## 2.11 Average species persistence vs cumulative habitat loss
## ------------------------------------------------------------

p_persist_avg <- ggplot(
  stage_summary,
  aes(x = loss_pct, y = avg_persistence_pct)
) +
  geom_line(color = neutral_blue, linewidth = 0.9) +
  geom_point(color = neutral_blue, size = 1.8) +
  scale_x_continuous(
    name   = "Cumulative habitat loss (%)",
    limits = c(0, 100),
    breaks = seq(0, 100, by = 20),
    expand = expansion(mult = c(0, 0.01))
  ) +
  scale_y_continuous(
    name   = "Average species persistence (%)",
    limits = c(0, 100),
    expand = expansion(mult = c(0, 0.03))
  ) +
  ggtitle("Average species persistence") +
  theme_clean(base_size = 11) +
  theme(
    plot.title      = element_text(hjust = 0.5, face = "bold"),
    legend.position = "none"
  )

print(p_persist_avg)

fig_path_persist <- file.path(path_outputs, "figure_species_persistence_average.png")
ggsave(
  filename = fig_path_persist,
  plot     = p_persist_avg,
  width    = 140,
  height   = 85,
  units    = "mm",
  dpi      = 600
)

message("Saved average species persistence figure to: ", fig_path_persist)
```

```{r}
library(data.table)
library(ggplot2)
library(patchwork)

## ------------------------------------------------------------
## 3.1 Attach group labels (Mammal vs Bird)
##    (all_metrics and stage_summary already exist from chunk 2)
## ------------------------------------------------------------

mammals <- c(
  "gymnuromys_roberti", "nesomys_rufus", "eliurus_minor",
  "eliurus_majori", "eliurus_myoxinus", "eliurus_tanala",
  "eliurus_webbi", "cryptoprocta_ferox", "fossa_fossana",
  "galidia_elegans", "echinops_telfairi", "hemicentetes_semispinosus",
  "microgale_brevicaudata", "microgale_cowani", "nesogale_dobsoni",
  "microgale_gymnorhyncha", "microgale_longicaudata", "microgale_parvula",
  "microgale_principula", "microgale_soricoides", "microgale_taiva",
  "nesogale_talazaci", "oryzorictes_hova", "setifer_setosus",
  "tenrec_ecaudatus", "eulemur_fulvus", "eulemur_rufus",
  "hapalemur_griseus", "indri_indri", "lepilemur_edwardsi",
  "lepilemur_leucopus", "lepilemur_ruficaudatus", "varecia_variegata",
  "cheirogaleus_medius", "cheirogaleus_major", "microcebus_rufus",
  "eulemur_albifrons", "eulemur_coronatus", "microcebus_murinus",
  "eulemur_rubriventer", "lepilemur_mustelinus"
)

birds <- c(
  "accipiter_madagascariensis", "coua_coquereli", "coua_serriana",
  "coua_cursor", "apus_balstoni", "asio_madagascariensis",
  "philepitta_castanea", "neodrepanis_coruscans", "foudia_madagascariensis",
  "hartlaubius_auratus", "foudia_omissa", "ploceus_nelicourvi",
  "accipiter_henstii", "newtonia_amphichroa", "mentocrex_kioloides",
  "calicalicus_madagascariensis", "coua_cristata", "brachypteracias_leptosomus",
  "lophotibis_cristata", "atelornis_crossleyi", "turnix_nigricollis",
  "buteo_brachypterus", "pterocles_personatus", "corythornis_madagascariensis",
  "lepidopygia_nana", "eremopterix_hova", "acrocephalus_newtoni",
  "motacilla_flaviventris", "monticola_sharpei", "xanthomixis_cinereiceps",
  "oxylabes_madagascariensis", "neomixis_viridis", "hypositta_corallirostris",
  "newtonia_brunneicauda", "mystacornis_crossleyi", "cyanolanius_madagascarinus",
  "xanthomixis_zosterops", "bernieria_madagascariensis", "coua_gigas",
  "pseudobias_wardi", "neomixis_striatigula", "gactornis_enarratus",
  "coracopsis_nigra", "athene_superciliaris", "alectroenas_madagascariensis",
  "polyboroides_radiatus", "tylas_eduardi", "aviceda_madagascariensis",
  "vanga_curvirostris", "leptopterus_chabert", "artamella_viridis",
  "sarothrura_insularis", "otus_rutilus", "cinnyris_notatus",
  "treron_australis"
)

species_groups <- data.table(
  species = c(mammals, birds),
  group   = factor(
    c(rep("Mammal", length(mammals)),
      rep("Bird",   length(birds))),
    levels = c("Mammal", "Bird")
  )
)

# Attach group to all species metrics (does NOT drop any species)
all_metrics <- merge(
  all_metrics,
  species_groups,
  by    = "species",
  all.x = TRUE,
  sort  = FALSE
)

## ------------------------------------------------------------
## 3.2 Species-level trajectories (counts, expected, persistence)
##    Uses stage_summary averages that already include all 96 spp
## ------------------------------------------------------------

species_traj_count <- all_metrics[
  ,
  .(stage, loss_pct, species, pct_weighted_count, group)
]

species_traj_exp <- all_metrics[
  ,
  .(stage, loss_pct, species, pct_weighted_exp, group)
]

species_traj_persist <- all_metrics[
  ,
  .(stage, loss_pct, species, species_persist_pct, group)
]

## Weighted PU count trajectories
p_species_count <- ggplot() +
  geom_line(
    data      = species_traj_count[!is.na(group)],
    aes(x = loss_pct, y = pct_weighted_count, group = species, color = group),
    alpha     = 0.35, linewidth = 0.4
  ) +
  geom_line(
    data        = stage_summary,
    aes(x = loss_pct, y = avg_pct_weighted_count, color = "Average"),
    linewidth   = 1, inherit.aes = FALSE
  ) +
  geom_point(
    data        = stage_summary,
    aes(x = loss_pct, y = avg_pct_weighted_count, color = "Average"),
    size        = 1.8, inherit.aes = FALSE
  ) +
  scale_x_continuous("Cumulative habitat loss (%)", limits = c(0, 100),
                     breaks = seq(0, 100, 20), expand = expansion(mult = c(0, 0.01))) +
  scale_y_continuous("Weighted PUs (%)", limits = c(0, 100),
                     expand = expansion(mult = c(0, 0.03))) +
  scale_color_manual(
    name   = NULL,
    values = c("Mammal" = "#CC6677", "Bird" = "#44AA99", "Average" = "black")
  ) +
  ggtitle("Species weighted PUs") +
  theme_clean(base_size = 11) +
  theme(legend.position = "top")

## Weighted expected PU trajectories
p_species_exp <- ggplot() +
  geom_line(
    data      = species_traj_exp[!is.na(group)],
    aes(x = loss_pct, y = pct_weighted_exp, group = species, color = group),
    alpha     = 0.35, linewidth = 0.4
  ) +
  geom_line(
    data        = stage_summary,
    aes(x = loss_pct, y = avg_pct_weighted_exp, color = "Average"),
    linewidth   = 1, inherit.aes = FALSE
  ) +
  geom_point(
    data        = stage_summary,
    aes(x = loss_pct, y = avg_pct_weighted_exp, color = "Average"),
    size        = 1.8, inherit.aes = FALSE
  ) +
  scale_x_continuous("Cumulative habitat loss (%)", limits = c(0, 100),
                     breaks = seq(0, 100, 20), expand = expansion(mult = c(0, 0.01))) +
  scale_y_continuous("Weighted expected PUs (%)", limits = c(0, 100),
                     expand = expansion(mult = c(0, 0.03))) +
  scale_color_manual(
    name   = NULL,
    values = c("Mammal" = "#CC6677", "Bird" = "#44AA99", "Average" = neutral_blue)
  ) +
  ggtitle("Species weighted expected PUs") +
  theme_clean(base_size = 11) +
  theme(legend.position = "top")

## Species persistence trajectories
p_species_persist <- ggplot() +
  geom_line(
    data      = species_traj_persist[!is.na(group)],
    aes(x = loss_pct, y = species_persist_pct, group = species, color = group),
    alpha     = 0.35, linewidth = 0.4
  ) +
  geom_line(
    data        = stage_summary,
    aes(x = loss_pct, y = avg_persistence_pct, color = "Average"),
    linewidth   = 1, inherit.aes = FALSE
  ) +
  geom_point(
    data        = stage_summary,
    aes(x = loss_pct, y = avg_persistence_pct, color = "Average"),
    size        = 1.8, inherit.aes = FALSE
  ) +
  scale_x_continuous("Cumulative habitat loss (%)", limits = c(0, 100),
                     breaks = seq(0, 100, 20), expand = expansion(mult = c(0, 0.01))) +
  scale_y_continuous("Species persistence (%)", limits = c(0, 100),
                     expand = expansion(mult = c(0, 0.03))) +
  scale_color_manual(
    name   = NULL,
    values = c("Mammal" = "#CC6677", "Bird" = "#44AA99", "Average" = "black")
  ) +
  ggtitle("Species persistence") +
  theme_clean(base_size = 11) +
  theme(legend.position = "top")

## ------------------------------------------------------------
## 3.3 Save figures (same filenames as before)
## ------------------------------------------------------------

fig_path_count   <- file.path(path_outputs, "figure_weighted_pu_trajectories_species.png")
fig_path_exp     <- file.path(path_outputs, "figure_weighted_expected_pu_trajectories_species.png")
fig_path_persist <- file.path(path_outputs, "figure_species_persistence_trajectories_species.png")

ggsave(fig_path_count,   p_species_count,   width = 140, height = 85, units = "mm", dpi = 600)
ggsave(fig_path_exp,     p_species_exp,     width = 140, height = 85, units = "mm", dpi = 600)
ggsave(fig_path_persist, p_species_persist, width = 140, height = 85, units = "mm", dpi = 600)

## Optional combined 3-panel figure
fig_species_panels <- (p_species_count + p_species_exp + p_species_persist +
  plot_layout(widths = c(1, 1, 1), guides = "collect")) +
  plot_annotation(tag_levels = "a", tag_prefix = "(", tag_suffix = ")") &
  theme(legend.position = "bottom")

fig_path_panels <- file.path(path_outputs, "figure_weighted_pu_and_persistence_species_panels.png")
ggsave(fig_path_panels, fig_species_panels, width = 210, height = 85, units = "mm", dpi = 600)

print(p_species_count)
print(p_species_exp)
print(p_species_persist)
```

```{r}
library(data.table)
library(ggplot2)

## ------------------------------------------------------------
## 4. Average mammals vs birds for all metrics
##    (Weighted PUs, Weighted expected PUs, Species persistence)
## ------------------------------------------------------------

# all_metrics must already have:
#   species, group (Mammal/Bird), stage, loss_pct,
#   pct_weighted_count, pct_weighted_exp, species_persist_pct

# 1) Stage-wise averages by group
group_stage_summary <- all_metrics[
  !is.na(group),
  .(
    avg_pct_weighted_count = mean(pct_weighted_count,  na.rm = TRUE),
    avg_pct_weighted_exp   = mean(pct_weighted_exp,    na.rm = TRUE),
    avg_persistence_pct    = mean(species_persist_pct, na.rm = TRUE)
  ),
  by = .(group, stage, loss_pct)
]

# 2) Long format for plotting
group_plot_df <- melt(
  group_stage_summary,
  id.vars      = c("group", "stage", "loss_pct"),
  measure.vars = c("avg_pct_weighted_count",
                   "avg_pct_weighted_exp",
                   "avg_persistence_pct"),
  variable.name = "metric",
  value.name    = "value"
)

group_plot_df[, metric_label :=
  fifelse(metric == "avg_pct_weighted_count", "Weighted PUs",
  fifelse(metric == "avg_pct_weighted_exp",   "Weighted expected PUs",
                                              "Species persistence"))
]

# 3) Plot
p_group_avg <- ggplot(
  group_plot_df,
  aes(
    x        = loss_pct,
    y        = value,
    color    = group,              # Mammal vs Bird
    linetype = metric_label,       # counts vs expected vs persistence
    group    = interaction(group, metric_label)
  )
) +
  geom_line(linewidth = 0.9) +
  scale_x_continuous(
    "Cumulative habitat loss (%)",
    limits = c(0, 100),
    breaks = seq(0, 100, by = 20),
    expand = expansion(mult = c(0, 0.01))
  ) +
  scale_y_continuous(
    "Metric value (%)",
    limits = c(0, 100),
    expand = expansion(mult = c(0, 0.03))
  ) +
  scale_color_manual(
    name   = "Group",
    values = c(
      "Mammal" = "#CC6677",
      "Bird"   = "#44AA99"
    )
  ) +
  scale_linetype_manual(
    name   = "Metric",
    values = c(
      "Weighted PUs"          = "solid",
      "Weighted expected PUs" = "dashed",
      "Species persistence"   = "dotdash"
    )
  ) +
  ggtitle("Average trajectories for mammals vs birds") +
  theme_clean(base_size = 11) +
  theme(
    plot.title         = element_text(hjust = 0.5, face = "bold"),
    legend.position    = "top",
    legend.margin      = margin(b = 2),
    legend.text        = element_text(size = 9),
    panel.grid.major.x = element_blank(),
    panel.grid.minor   = element_blank()
  )

print(p_group_avg)

# 4) Save
fig_path_group <- file.path(path_outputs, "figure_group_average_mammal_vs_bird_all_metrics.png")
ggsave(
  filename = fig_path_group,
  plot     = p_group_avg,
  width    = 140,
  height   = 85,
  units    = "mm",
  dpi      = 600
)
```

```{r}
## ============================================================
## Zonation scenario metrics (alt prioritization)
##    - Uses patch_lookup_zonation_rank_XX.rds
##    - Computes: N, expected N, species persistence
##    - Treats missing species as extinct (0s)
##    - Ensures a 100% loss point with zero metrics
## ============================================================

library(data.table)

path_spatial  <- "Spatial"
path_zonation <- file.path(path_spatial, "zonation_outputs")

# Full species set from params (same as original scenario)
species_all <- data.table(species = params$species)

# Removal proportions that have corresponding patch lookup tables
zonation_removal_props <- seq(from = 0.025, to = 0.975, by = 0.025)

zonation_metrics_list <- list()

## ------------------------------------------------------------
## 1. Stage 0 (removal_prop = 0): use original patch_dt_0
## ------------------------------------------------------------

m0_zon <- compute_species_metrics(patch_dt_0, params)

# Force all species to appear; those with no PUs get 0s (extinct)
m0_zon <- species_all[m0_zon, on = .(species)]
m0_zon[is.na(weighted_pu_count), `:=`(
  weighted_pu_count    = 0,
  weighted_expected_pu = 0,
  species_persistence  = 0
)]
m0_zon[, removal_prop := 0]

zonation_metrics_list[[length(zonation_metrics_list) + 1L]] <- m0_zon

## ------------------------------------------------------------
## 2. Later stages: read zonation patch lookup tables
## ------------------------------------------------------------

for (rp in zonation_removal_props[zonation_removal_props > 0]) {
  f <- file.path(path_zonation, sprintf("patch_lookup_zonation_rank_%.2f.rds", rp))
  if (!file.exists(f)) {
    warning("Zonation patch lookup not found for removal_prop = ", rp, ": ", f)
    next
  }

  patch_dt_zon <- as.data.table(readRDS(f))
  if ("removal_prop" %in% names(patch_dt_zon)) {
    patch_dt_zon[, removal_prop := NULL]
  }

  mk <- compute_species_metrics(patch_dt_zon, params)

  # Again, force all species to appear; missing => extinct (0)
  mk <- species_all[mk, on = .(species)]
  mk[is.na(weighted_pu_count), `:=`(
    weighted_pu_count    = 0,
    weighted_expected_pu = 0,
    species_persistence  = 0
  )]
  mk[, removal_prop := rp]

  zonation_metrics_list[[length(zonation_metrics_list) + 1L]] <- mk
}

## ------------------------------------------------------------
## 3. Stack all removal_prop levels
## ------------------------------------------------------------

zonation_metrics <- rbindlist(zonation_metrics_list, use.names = TRUE, fill = TRUE)

# Clamp any weird persistence values
zonation_metrics[!is.finite(species_persistence) | species_persistence < 0,
                 species_persistence := 0]
zonation_metrics[species_persistence > 1, species_persistence := 1]

## ------------------------------------------------------------
## 4. Baseline scaling (removal_prop = 0) and % metrics
## ------------------------------------------------------------

zonation_baseline <- zonation_metrics[
  removal_prop == 0 & weighted_pu_count > 0,
  .(baseline_weighted_count = weighted_pu_count),
  by = species
]

# Restrict to species with positive baseline (same logic as original scenario)
zonation_metrics <- zonation_baseline[zonation_metrics, on = .(species)]
zonation_metrics <- zonation_metrics[baseline_weighted_count > 0]

zonation_metrics[
  ,
  `:=`(
    pct_weighted_count  = 100 * weighted_pu_count    / baseline_weighted_count,
    pct_weighted_exp    = 100 * weighted_expected_pu / baseline_weighted_count,
    species_persist_pct = 100 * species_persistence
  )
]

## ------------------------------------------------------------
## 5. Stage summary (average across species) for zonation
## ------------------------------------------------------------

zonation_stage_summary <- zonation_metrics[
  ,
  .(
    avg_pct_weighted_count_zonation = mean(pct_weighted_count,  na.rm = TRUE),
    avg_pct_weighted_exp_zonation   = mean(pct_weighted_exp,    na.rm = TRUE),
    avg_species_persist_zonation    = mean(species_persistence, na.rm = TRUE)
  ),
  by = removal_prop
][order(removal_prop)]

zonation_stage_summary[, loss_pct  := 100 * removal_prop]
zonation_stage_summary[, remaining_pct := 100 - loss_pct]
zonation_stage_summary[, avg_persistence_pct_zonation := 100 * avg_species_persist_zonation]

# Attach loss_pct to species-level metrics for plotting
zonation_metrics[, loss_pct := 100 * removal_prop]

## ------------------------------------------------------------
## 6. Ensure a 100% loss point with zero metrics for zonation
## ------------------------------------------------------------

has_full_zon <- any(zonation_stage_summary$loss_pct >= 100 - 1e-6)

if (!has_full_zon) {
  # Average-level 100% loss row (all metrics = 0)
  zonation_stage_summary <- rbind(
    zonation_stage_summary,
    data.table(
      removal_prop                    = 1,
      avg_pct_weighted_count_zonation = 0,
      avg_pct_weighted_exp_zonation   = 0,
      avg_species_persist_zonation    = 0,
      avg_persistence_pct_zonation    = 0,
      loss_pct                        = 100,
      remaining_pct                   = 0
    ),
    use.names = TRUE
  )
  data.table::setorder(zonation_stage_summary, removal_prop)

  # Species-level rows at 100% loss (only for baseline species)
  species_full_zon <- zonation_baseline$species

  full_z_rows <- data.table(
    species                = species_full_zon,
    baseline_weighted_count = zonation_baseline$baseline_weighted_count,
    weighted_pu_count      = 0,
    weighted_expected_pu   = 0,
    species_persistence    = 0,
    pct_weighted_count     = 0,
    pct_weighted_exp       = 0,
    species_persist_pct    = 0,
    removal_prop           = 1,
    loss_pct               = 100
  )

  zonation_metrics <- rbind(zonation_metrics, full_z_rows, use.names = TRUE, fill = TRUE)
  data.table::setorder(zonation_metrics, species, removal_prop)
}
```

```{r}
library(data.table)
library(ggplot2)
library(patchwork)

library(scales)

rev_log10_pct <- trans_new(
  "rev_log10_pct",
  transform = function(x) -log10(101 - x),      # stretches values near 100
  inverse   = function(x) 101 - 10^(-x),        # back-transform to % scale
  domain    = c(0, 100)
)

## ------------------------------------------------------------
## 7.1 Average weighted PUs (% of baseline)
## ------------------------------------------------------------

df_avg_count <- rbindlist(list(
  stage_summary[
    ,
    .(scenario = "Original",
      loss_pct,
      value = avg_pct_weighted_count)
  ],
  zonation_stage_summary[
    ,
    .(scenario = "Zonation",
      loss_pct,
      value = avg_pct_weighted_count_zonation)
  ]
))

p_avg_count <- ggplot(
  df_avg_count,
  aes(x = loss_pct, y = value,
      color = scenario, linetype = scenario)
) +
  geom_line(linewidth = 0.9) +
  geom_point(size = 1.8) +
  scale_x_continuous(
    "Cumulative habitat loss (%)",
    limits = c(0, 100),
    breaks = seq(0, 100, by = 20)
  ) +
  scale_y_continuous(
    "Weighted PUs (%)",
    limits = c(0, 100)
  ) +
  scale_color_manual(values = c(
    "Original" = "grey35",
    "Zonation" = "black"
  )) +
  scale_linetype_manual(values = c(
    "Original" = "solid",
    "Zonation" = "dashed"
  )) +
  ggtitle("Average weighted PUs (original vs zonation)") +
  theme_clean(base_size = 11) +
  theme(
    plot.title      = element_text(hjust = 0.5, face = "bold"),
    legend.position = "top"
  )

ggsave(
  filename = file.path(path_outputs, "figure_avg_weighted_pu_original_vs_alt.png"),
  plot     = p_avg_count,
  width    = 140, height = 85,
  units    = "mm", dpi = 600
)

## ------------------------------------------------------------
## 7.2 Average weighted expected PUs (% of baseline)
## ------------------------------------------------------------

df_avg_exp <- rbindlist(list(
  stage_summary[
    ,
    .(scenario = "Original",
      loss_pct,
      value = avg_pct_weighted_exp)
  ],
  zonation_stage_summary[
    ,
    .(scenario = "Zonation",
      loss_pct,
      value = avg_pct_weighted_exp_zonation)
  ]
))

p_avg_exp <- ggplot(
  df_avg_exp,
  aes(x = loss_pct, y = value,
      color = scenario, linetype = scenario)
) +
  geom_line(linewidth = 0.9) +
  geom_point(size = 1.8) +
  scale_x_continuous(
    "Cumulative habitat loss (%)",
    limits = c(0, 100),
    breaks = seq(0, 100, by = 20)
  ) +
  scale_y_continuous(
    "Weighted expected PUs (%)",
    limits = c(0, 100)
  ) +
  scale_color_manual(values = c(
    "Original" = neutral_blue,
    "Zonation" = "black"
  )) +
  scale_linetype_manual(values = c(
    "Original" = "solid",
    "Zonation" = "dashed"
  )) +
  ggtitle("Average weighted expected PUs (original vs zonation)") +
  theme_clean(base_size = 11) +
  theme(
    plot.title      = element_text(hjust = 0.5, face = "bold"),
    legend.position = "top"
  )

ggsave(
  filename = file.path(path_outputs, "figure_avg_weighted_expected_pu_original_vs_alt.png"),
  plot     = p_avg_exp,
  width    = 140, height = 85,
  units    = "mm", dpi = 600
)

## ------------------------------------------------------------
## 7.3 Average species persistence (%)
## ------------------------------------------------------------

df_avg_persist <- rbindlist(list(
  stage_summary[
    ,
    .(scenario = "Original",
      loss_pct,
      value = avg_persistence_pct)
  ],
  zonation_stage_summary[
    ,
    .(scenario = "Zonation",
      loss_pct,
      value = avg_persistence_pct_zonation)
  ]
))

p_avg_persist <- ggplot(
  df_avg_persist,
  aes(x = loss_pct, y = value,
      color = scenario, linetype = scenario)
) +
  geom_line(linewidth = 0.9) +
  geom_point(size = 1.8) +
  scale_x_continuous(
    "Cumulative habitat loss (%)",
    limits = c(0, 100),
    breaks = seq(0, 100, by = 20)
  ) +
  scale_y_continuous(
    "Average species persistence (%)",
    limits = c(0, 100)
  ) +
  scale_color_manual(values = c(
    "Original" = neutral_blue,
    "Zonation" = "black"
  )) +
  scale_linetype_manual(values = c(
    "Original" = "solid",
    "Zonation" = "dashed"
  )) +
  ggtitle("Average species persistence (original vs zonation)") +
  theme_clean(base_size = 11) +
  theme(
    plot.title      = element_text(hjust = 0.5, face = "bold"),
    legend.position = "top"
  )

ggsave(
  filename = file.path(path_outputs, "figure_avg_persistence_original_vs_alt.png"),
  plot     = p_avg_persist,
  width    = 140, height = 85,
  units    = "mm", dpi = 600
)

print(p_avg_count)
print(p_avg_exp)
print(p_avg_persist)

## ------------------------------------------------------------
## 7.4 Combined 3-panel figure
## ------------------------------------------------------------

fig_avg_panels <- (p_avg_count + p_avg_exp + p_avg_persist +
  plot_layout(widths = c(1, 1, 1), guides = "collect")) +
  plot_annotation(
    tag_levels = "a",
    tag_prefix = "(",
    tag_suffix = ")"
  ) &
  theme(
    plot.tag        = element_text(face = "bold", size = 11),
    legend.position = "bottom"
  )

ggsave(
  filename = file.path(path_outputs, "figure_avg_metrics_original_vs_alt_panels.png"),
  plot     = fig_avg_panels,
  width    = 210, height = 85,
  units    = "mm", dpi = 600
)
```